<html lang="zh-cmn">
<head>
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/xterm/3.14.5/xterm.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xterm/3.14.5/xterm.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.4.0/sockjs.min.js"></script>
  <style>
    body {
      color: #111;
      margin: 20px;
    }

    #terminal-container {
      margin: 0 auto;
    }

    #terminal-container a {
      color: #fff;
    }

    #panel-body {
      background-color: #000;
    }
  </style>
  <title></title>
</head>
<body style="border-width: 0;margin:0" id="panel-body">

<div id="connect_container" style="background-color: #ffffff">
<form class="form-inline" style="margin: 0">
  <button type="button" class="btn btn-default" onclick="ws_connect()" >连接</button>
</form>
</div>
<div style="padding: 0;border: 0;margin: 0">
  <div id="terminal-container"></div>
</div>
<script>
  window.onload = function() {
    ws_connect()
  //  function timedRefresh(timeoutPeriod) {
  //    setTimeout("location.reload(true);",timeoutPeriod);
  //  }
  //  timedRefresh(100000);
  }
  // 获取宽度和高度
  console.log(document.body.clientWidth)
  cols = parseInt(document.body.clientWidth / 9)
  rows = parseInt(document.body.clientHeight / 20)
  console.log(rows, cols)
  // 定义term对象
  const term = new Terminal({
    'cursorBlink': true,
    'rows': rows,
    'cols': cols
  })

  // 定义ws链接
  function ws_connect() {
    let socket
    // 隐藏连接按钮显示断开按钮
    const connect_container = document.getElementById('connect_container')
    // const drop_container= document.getElementById('drop_container')
    connect_container.hidden = true
    // drop_container.hidden = false
    // 生成参数
    const localURL = window.location.href.split('/')[2]
    let url = new URL(window.location.href)
    let h = url.searchParams.get('clusterId')
    let p = url.searchParams.get('projectId')
    if (h === '' || p === '') {
      alert('不能为空!')
      return false
    }
    let namespace = url.searchParams.get('namespace')
    let pod = url.searchParams.get('pod')
    let container = url.searchParams.get('container')
    url = 'http://nfyxhan.com/v2/ws/bash'+'?' + 'rows=' + rows + '&cols=' + cols +
        '&namespace=' + namespace + '&pod='+pod+'&container='+container 
    // 生成socket对象
    socket = new SockJS(url)
    // 获取term div
    const terminalContainer = document.getElementById('terminal-container')
    terminalContainer.innerHTML = ""
    term.open(terminalContainer)
    term.on('data', function(data) {
      if (socket.readyState === 1) {
        socket.send(data)
      }
    })
    socket.onmessage = function(e) {
      term.write(e.data)
    }
    socket.onclose = function(e) {
      term.write('session is close')
      connect_container.hidden = false
    }
    socket.onopen = function() {
      resize(socket)
    }
    window.onresize = function() {
      resize(socket)
    }
  }

  function resize(socket) {
    const cols = parseInt(document.body.clientWidth / 9)
    const rows = parseInt(document.body.clientHeight / 20)
    term.resize(cols, rows)
    socket.send('{"cols":' + cols + ',"rows":' + rows + '}')
  }
</script>
</body>
</html>

